{template 'member', 'header'}
<script type="text/javascript" src="{JS_PATH}formvalidator.js" charset="UTF-8"></script>
<script type="text/javascript" src="{JS_PATH}formvalidatorregex.js" charset="UTF-8"></script>
<link href="{CSS_PATH}dialog.css" rel="stylesheet" type="text/css" />
<script language="javascript" type="text/javascript" src="{JS_PATH}dialog.js"></script>
<script src="{JS_PATH}layer/layer.js"></script>
<link href="{PLUGIN_STATICS_PATH}select2/select2.min.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="{PLUGIN_STATICS_PATH}select2/select2.full.min.js" charset="UTF-8"></script>
<script type="text/javascript" src="{JS_PATH}jquery.form.min.js" charset="UTF-8"></script>
<style type="text/css">
	.select2-hidden-accessible{border:0 !important;clip:rect(0 0 0 0) !important;height:1px !important;margin:-1px !important;overflow:hidden !important;padding:0 !important;position:absolute !important;width:1px !important}
</style>
<script language="JavaScript">
<!--
$(function(){
	$.formValidator.initConfig({autotip:true,formid:"myform",onerror:function(msg){}});
	$("#nickname").formValidator({onshow:"{L('input').L('nickname')}",onfocus:"{L('nickname').L('between_2_to_20')}"}).inputValidator({min:2,max:20,onerror:"{L('nickname').L('between_2_to_20')}"}).regexValidator({regexp:"ps_username",datatype:"enum",onerror:"{L('nickname').L('format_incorrect')}"}).ajaxValidator({
	    type : "get",
		url : "",
		data :"m=member&c=index&a=public_checknickname_ajax&userid={$memberinfo[userid]}",
		datatype : "html",
		async:'false',
		success : function(data){
            if( data == "1" ) {
                return true;
			} else {
                return false;
			}
		},
		buttons: $("#dosubmit"),
		onerror : "{L('already_exist')}",
		onwait : "{L('connecting_please_wait')}"
	}).defaultPassed();

	{$formValidator}
});

function layer_open() {
	$.post('index.php?m=content&c=index&a=getCompany',{catid:120},function (result) {
		if (result){
			var html = '<select name="company" id="company" class="pc-select-area"><option value="">请选择</option>';
			$.each(result,function (k,v) {
				html+= '<option value="'+v.title+'">'+v.title+'</option>';
			});
			html+='</select>';
			layer.open({
				 content: html
				,btn: ['确定']
				,yes: function(index, layero){
					//按钮【按钮一】的回调
                    var company = $("#company").val();
                    $("input[name='info[unit_name]']").val(company);
					layer.close(index);
				}
				,cancel: function(){
					//右上角关闭回调

					//return false 开启该代码可禁止点击该按钮关闭
				}
			});
		}else {
			layer.alert('获取公司列表出错', {icon: 2});
		}

	},'json');
}
//-->
</script>
<div id="memberArea">
	{template 'member', 'account_manage_left'}
	<div class="col-auto">
	
		<div class="point" id='announcement'>
			<a href="javascript:hide_element('announcement');" hidefocus="true" class="close"><span>{L('close')}</span></a>
			<div class="content">
				<strong class="title">{L('notice')}：</strong>
				<p>{L('with_star_must_input')}</p>
			</div>
		</div>
       		
		<div class="col-1 ">
			<h5 class="title">{L('modify').L('memberinfo')}</h5>           
			<div class="content">			
			<form method="post" action="" id="myform" name="myform">
				<table width="100%" cellspacing="0" class="table_form">
					<tr>
						<th width="100">{L('nickname')}</th> 
						<td><input id="nickname" name="nickname" value="{$memberinfo['nickname']}" type="text" class="input-text" size="30"></td>
					</tr>
					{loop $forminfos $k $v}
					{if $k == 'unit_name'}
					<tr>
						<th width="100">单位名称：</th>
						<td>
							<input id="company_name" name="info[unit_name]" value="{$memberinfo['unit_name']}" type="text" class="input-text" size="30" list="companyList">
							<datalist id="companyList">

							</datalist>
						</td>
					</tr>
					{php continue;}
					{elseif $k == 'wechat_img'}
					<tr>
						<th width="100">微信二维码：</th>
						<td>
							<div class="upload-pic img-wrap">
								<input type="hidden" name="info[wechat_img]" id="wechat_img" value="{$memberinfo['wechat_img']}">
								<a><img src="{$memberinfo['wechat_img']}" onerror="this.src='/statics/images/icon/upload-pic.png'" id="wechat_img_preview" style="cursor:hand" width="135" height="113"></a>
							</div>
						<td>
					</tr>
					{php continue;}
					{/if}
					<tr>
						<th width="100">{if $v['isbase']}<font color=red>*</font>{/if} {$v['name']}：{if $v['tips']}<br />({$v['tips']}){/if}</th> 
						<td>{$v['form']}</td>
					</tr>
					{/loop}
					<tr>
						<th></th>
						<td><input name="dosubmit" type="submit" id="dosubmit" value="{L('submit')}" class="button"></td>
					</tr>
				</table>
			</form>
			<form id="fileForm" enctype="multipart/form-data" action="index.php?m=content&c=index&a=upload" method="post">
				<input type="file" id="file" name="upload" style="display: none;" multiple="multiple">
			</form>
			</div>
			<span class="o1"></span><span class="o2"></span><span class="o3"></span><span class="o4"></span>
		</div>
	</div>
</div>
<div class="clear"></div>
{template 'member', 'footer'}
<script>
    /*$(document).ready(function(){
        $('#company').select2(
            {
                ajax: {
                    url: 'index.php?m=content&c=index&a=getCompany',
                    dataType: 'json',
                    delay: 1000,
                    data: function (params) {
                        return {
                            q: params.term, // search term
                            page: params.page,
                            row: 10
                        };
                    },
                    processResults: function (data, params) {
                        params.page = params.page || 1;
                        return {
                            results: data.items,
                            pagination: {
                                more: (params.page * 10) < data.total
                            }
                        };
                    },
                    cache: true
                }
            }
		);
	});*/

    /*$("#company").change(function(){
        var company = $("#company option:selected").text();
        $("input[name='info[unit_name]']").val(company);
        $('#company_name').val(company);
    });*/

    $("#company_name").on('input',function(e){
        $.post('index.php?m=content&c=index&a=getCompany',{q:$(this).val()},function (result) {
            if (result){
                var html = '';
                $.each(result.items,function (k,v) {
                    html+= '<option value="'+v.text+'" />';
                });
                $('#companyList').html(html);
            }else {
                layer.alert('获取公司列表出错', {icon: 2});
            }

        },'json');

        //$("input[name='info[unit_name]']").val($(this).val());
    });

    $("#wechat_img_preview").click(function () {
        $('#file').trigger('click');
    });

    $('#file').on('change',function () {
        $('#fileForm').ajaxSubmit(function (result) {
            if(result){
                $('#wechat_img').val(result);
                $('#wechat_img_preview').attr('src',result);
            }else {
                layer.alert('上传失败', {icon: 2});
            }
            $("#file").val('');
        });
    });
</script>